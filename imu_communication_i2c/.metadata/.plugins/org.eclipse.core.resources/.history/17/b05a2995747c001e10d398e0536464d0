//IMU_communication

#include <stdio.h>
#include <stdlib.h>
#include "system.h"
#include <string.h>
#include "altera_avalon_pio_regs.h"
#include <altera_avalon_uart.h>
#include "altera_avalon_uart_regs.h"
//#include <altera_avalon_i2c.h>
//#include "altera_avalon_i2c_regs.h"
#include "sys/alt_irq.h"
#include <math.h>
#include <io.h>
#include <unistd.h>


#define interval 20000//micro s
#define TRUE 1
#define FALSE 0
//REGISTER DEFINITION START
#define SENSORS_GRAVITY_EARTH             (9.80665F)              /**< Earth's gravity in m/s^2 */
#define SENSORS_GRAVITY_MOON              (1.6F)                  /**< The moon's gravity in m/s^2 */
#define SENSORS_GRAVITY_SUN               (275.0F)                /**< The sun's gravity in m/s^2 */
#define SENSORS_GRAVITY_STANDARD          (SENSORS_GRAVITY_EARTH)
#define SENSORS_MAGFIELD_EARTH_MAX        (60.0F)                 /**< Maximum magnetic field on Earth's surface */
#define SENSORS_MAGFIELD_EARTH_MIN        (30.0F)                 /**< Minimum magnetic field on Earth's surface */
#define SENSORS_PRESSURE_SEALEVELHPA      (1013.25F)              /**< Average sea level pressure is 1013.25 hPa */
#define SENSORS_DPS_TO_RADS               (0.017453293F)          /**< Degrees/s to rad/s multiplier */
#define SENSORS_GAUSS_TO_MICROTESLA       (100)                   /**< Gauss to micro-Tesla multiplier */

#define BNO055_ADDR 0x28
#define STOP_BIT 0x100


//Operation mode setting
#define OPR_MODE_ADDR 0x3d
#define CONFIG_MODE 0x00
#define GYRONLY_MODE 0x03
#define ACC_GYRO_MODE 0x05
#define AMG_MODE 0x07
#define IMU_MODE 0x0c

//Power mode setting
#define PWR_MODE_ADDR 0x3e
#define NORMAL_MODE 0x00
#define LOW_MODE 0x01
#define SUSPEND_MODE 0x02

//Caliblation
#define CALIB_STAT_ADDR 0x35

//Status registers
#define CHIP_ID 0x00
#define SYS_CLK_STAT 0x38

//加速度アドレス
#define ACC_X_LSB 0x08
#define ACC_X_MSB 0x09
#define ACC_Y_LSB 0x0a
#define ACC_Y_MSB 0x0b
#define ACC_Z_LSB 0x0c
#define ACC_Z_MSB 0x0d
//角速度アドレス
#define GYR_X_LSB 0x14
#define GYR_X_MSB 0x15
#define GYR_Y_LSB 0x16
#define GYR_Y_MSB 0x17
#define GYR_Z_LSB 0x18
#define GYR_Z_MSB 0x19
//クォータニオン(姿勢）
#define QUA_W_LSB 0x20
#define QUA_W_MSB 0x21
#define QUA_X_LSB 0x22
#define QUA_X_MSB 0x23
#define QUA_Y_LSB 0x24
#define QUA_Y_MSB 0x25
#define QUA_Z_LSB 0x26
#define QUA_Z_MSB 0x27
//I2C IP core
#define ENABLE 0x3//BUS_SPEED:高速(400kbps),ENABLE:有効
#define DISABLE 0x0

//UART
#define UART_START 0xaa
#define UART_READ 0x01
#define UART_WRITE 0x00
#define RES_SUCCESS 0xbb
#define RES_FAIL 0xee


unsigned short quat_w,quat_x,quat_y,quat_z;


unsigned short IMU_READ(short adr){
	int i;
	short rd_data;
	short rd_status;
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,UART_START);//start byte
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,UART_READ);//read 0x01
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,adr);//address
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,1);//length

	while(1){
		rd_data=IORD_ALTERA_AVALON_UART_RXDATA(UART2_BASE);
	if(rd_data==RES_SUCCESS){//0xbb
		rd_data=IORD_ALTERA_AVALON_UART_RXDATA(UART2_BASE);
		if(rd_data!=RES_SUCCESS){
			return rd_data;
		}
	}
	else if(rd_data==RES_FAIL){//0xee
		rd_data=IORD_ALTERA_AVALON_UART_RXDATA(UART2_BASE);
		if(rd_data!=RES_FAIL){
			printf("Error:%04d\n",rd_data);
			return 0;
		}
	}
	}
	return 0;
}

void IMU_WRITE(short adr,short data){
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,UART_START);//start byte
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,UART_WRITE);//write 0x00
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,adr);//address
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,1);//length
	IOWR_ALTERA_AVALON_UART_TXDATA(UART2_BASE,data);//data
	}

int IMU_init(void){//IMU,I2Cの初期化関数
	IOWR_ALTERA_AVALON_UART_STATUS(UART2_BASE,0);//ステータスレジスタをクリア
	printf("CHIP_ID=%04d\n",IMU_READ(CHIP_ID));
	IMU_WRITE(OPR_MODE_ADDR,CONFIG_MODE);//CONFIG_MODE
	IMU_WRITE(PWR_MODE_ADDR,NORMAL_MODE);
	IMU_WRITE(CALIB_STAT_ADDR,NORMAL_MODE);
	IMU_WRITE(OPR_MODE_ADDR,IMU_MODE);//IMU_MODE

	return 0;
}

int main(){
	unsigned short quat_w,quat_x,quat_y,quat_z,acc_x,acc_y,acc_z;
	printf("I2C_START\n");
	IMU_init();

	while(1){
//		//acc
//		acc_x=IMU_READ(ACC_X_LSB)|(IMU_READ(ACC_X_MSB)<<8);
//		acc_y=IMU_READ(ACC_Y_LSB)|(IMU_READ(ACC_Y_MSB)<<8);
//		acc_z=IMU_READ(ACC_Z_LSB)|(IMU_READ(ACC_Z_MSB)<<8);
//        printf("acc_x=%04d ",acc_x);
//        printf("acc_y=%04d ",acc_y);
//        printf("acc_z=%04d ",acc_z);
//        printf("\n");

        //quaternion
		quat_w=IMU_READ(QUA_W_LSB)|(IMU_READ(QUA_W_MSB)<<8);
		quat_x=IMU_READ(QUA_X_LSB)|(IMU_READ(QUA_X_MSB)<<8);
		quat_y=IMU_READ(QUA_Y_LSB)|(IMU_READ(QUA_Y_MSB)<<8);
		quat_z=IMU_READ(QUA_Z_LSB)|(IMU_READ(QUA_Z_MSB)<<8);
        printf("quat_w=%04d ",quat_w);
        printf("quat_x=%04d ",quat_x);
        printf("quat_y=%04d ",quat_y);
        printf("quat_z=%04d ",quat_z);
        printf("\n");

	}
return 0;
}
